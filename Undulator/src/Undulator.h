/*----- PROTECTED REGION ID(Undulator.h) ENABLED START -----*/
//=============================================================================
//
// file :        Undulator.h
//
// description : Include for the Undulator class.
//
// project :     .
//
// $Author:  $
//
// $Revision:  $
// $Date:  $
//
// SVN only:
// $HeadURL:  $
//
// CVS only:
// $Source:  $
// $Log:  $
//
//=============================================================================
//                This file is generated by POGO
//        (Program Obviously used to Generate tango Object)
//=============================================================================


#ifndef UNDULATOR_H
#define UNDULATOR_H


#include <tango.h>
#include <string>
#include <vector>
#include <insertion/EPUData.h>


/*----- PROTECTED REGION END -----*/


/**
 *	Undulator class Description:
 *	Device server for control of  EPU61 insertion device with Galil DMC 4080 controllers.
 *	
 */

namespace Undulator_ns
{
	/*----- PROTECTED REGION ID(Undulator::Additional Class Declarations) ENABLED START -----*/


    class Communicator;

    class PollerThread;
    class CorrectionCoils;
    class FlagsProcessor;
    class StateProcessor;

	/*----- PROTECTED REGION END -----*/	//	Undulator::Additional Class Declarations


class Undulator : public Tango::Device_4Impl
{


	/*----- PROTECTED REGION ID(Undulator::Data Members) ENABLED START -----*/
private:
 	omni_mutex deviceLock; //!< Lock for shared variables.

    double desiredGap; //!< Target gap in user units.
    double desiredTaper; //!< Target taper in user units.
    double desiredCenter; //!< Target center in user units.
    double desiredOffset; //!< Desired phase offset.
    short desiredPhaseMode; //!< Selected phase mode.

    vector<double> offsetsGapVector; //!< Holds all gap axes offsets.
    vector<double> offsetsPhaseVector; //!< Holds all phase axes offsets.

    bool engineeringLock; 	//!< Engineering mode lock.

	IDPosition idPosition; 	//!< Current insertion device position
	IDStatus   idStatus;	//!< Current insertion device status

    double taperSpeed; //!< Speed used when adjusting taper.
    double gapSpeed; //!< Speed used when moving gap.
    double phaseSpeed; //!< Speed used when moving to phase offset.

    double engineeringGapAxesSpeed; //!< Axes moving gap maximum speed in engineering mode.
    double engineeringPhaseAxesSpeed; //!< Axes moving phase maximum speed in engineering mode.

    double engineeringGapAxesAcceleration; //!< Axes moving gap acceleration and deceleration in engineering mode.
    double engineeringPhaseAxesAcceleration; //!< Axes moving phase acceleration and deceleration in engineering mode.

    double phaseAcc; //!< Phase movement acceleration and deceleration.
    double gapAcc; //!< Gap movement acceleration and deceleration.
    double taperAcc; //! Taper movement acceleration and deceleration.

    double positionRatioGap; //!< Counts to micrometers ratio for gap motors.
    double positionRatioPhase; //!< Counts to micrometers ratio for phase motors.

    double maxGap; //!< Maximal gap allowed.
    double minGap; //!< Minimal gap allowed.
    double maxOpPhase; //!< Maximal phase offset allowed.

    double cycleTime; //!< Poller thread cycle time

    Communicator *comm; 		//!< Pointer to class that does the actual communication. This instance will be used from Tango threaded calls.

    PollerThread 	*poller; 				//!< Pointer to poller thread that handles hardware accesses.
    StateProcessor 	*stateProc; 			//!< Pointer to poller thread processor that handles undulator state based on individual axes state
    CorrectionCoils *correctionCoils; 		//!< Pointer to coils correction thread processor - updates coils and undulator position
    FlagsProcessor 	*flagProc;				//!< Pointer to poller thread processor that polls for IDStatus flags

    bool coilCorrectionEnabled;	//!< Flag indicating whether coil correction is running

    Tango::Group *phaseAxesGroup; //!< Group with phase axes.
    Tango::Group *gapAxesGroup; //!< Group with gap axes.


	/*----- PROTECTED REGION END -----*/	//	Undulator::Data Members


//	Device property data members
public:		//	ControlBoxGapProxy:	Proxy to ControlBox with gap DMC
	string	controlBoxGapProxy;
	//	GapAxes:	Proxy to axes that control gap movement. Order: Z1,Z2,Z3,Z4
	vector<string>	gapAxes;
	//	PhaseAxes:	Proxy to axes that control phase movement.  Order: X1,X2,X3,X4
	vector<string>	phaseAxes;
	//	ControlBoxPhaseProxy:	Proxy to controlbox with phase DMC
	string	controlBoxPhaseProxy;
	//	GearedAxes:	Proxy to GalilGearedAxes that control upper and lower girder. Order: Upper girder, Lower girder
	vector<string>	gearedAxes;
	//	DataFile:	Filename containing interpolation data.
	string	dataFile;
	//	PowerSupplyProxy:	Proxy server where power supply will read and write current.
	string	powerSupplyProxy;
	//	PowerSupplyAttributeNames:	Attribute name for each power supply to read from and write to.
	vector<string>	powerSupplyAttributeNames;
	//	PollerCycleDelay:	Delay, in microseconds, between poller thread cycles
	Tango::DevULong	pollerCycleDelay;
	//	StateProcMultiplier:	State processing takes place each N-th poller thread cycle
	Tango::DevULong	stateProcMultiplier;
	//	CoilProcMultiplier:	Coil processing takes place every N-th poller cycle
	Tango::DevULong	coilProcMultiplier;
	//	FlagsProcMultiplier:	Flags processing happens every N-th poller thread cycle
	Tango::DevULong	flagsProcMultiplier;
	

//	Attribute data members
public:
	Tango::DevDouble	*attr_Gap_read;
	Tango::DevBoolean	*attr_EngineeringLock_read;
	Tango::DevDouble	*attr_GapAcceleration_read;
	Tango::DevDouble	*attr_GapSpeed_read;
	Tango::DevDouble	*attr_PhaseAcceleration_read;
	Tango::DevShort	*attr_PhaseMode_read;
	Tango::DevDouble	*attr_Phase_read;
	Tango::DevDouble	*attr_PhaseSpeed_read;
	Tango::DevDouble	*attr_TaperAcceleration_read;
	Tango::DevDouble	*attr_Taper_read;
	Tango::DevDouble	*attr_Offset_read;
	Tango::DevDouble	*attr_TaperSpeed_read;
	Tango::DevBoolean	*attr_StopAll_read;
	Tango::DevBoolean	*attr_GapMoving_read;
	Tango::DevBoolean	*attr_PhaseMoving_read;
	Tango::DevDouble	*attr_EngineeringGapSpeed_read;
	Tango::DevDouble	*attr_EngineeringPhaseSpeed_read;
	Tango::DevDouble	*attr_EngineeringGapAcceleration_read;
	Tango::DevDouble	*attr_EngineeringPhaseAcceleration_read;
	Tango::DevBoolean	*attr_Interlock_read;
	Tango::DevBoolean	*attr_CorrectionEnabled_read;
	Tango::DevULong	*attr_AxesFlags_read;
	Tango::DevDouble	*attr_CycleTime_read;



//	Constructors and destructors
public:
	/**
	 * Constructs a newly allocated Command object.
	 *
	 *	@param cl	Class.
	 *	@param s 	Device Name
	 */
	Undulator(Tango::DeviceClass *cl,string &s);
	/**
	 * Constructs a newly allocated Command object.
	 *
	 *	@param cl	Class.
	 *	@param s 	Device Name
	 */
	Undulator(Tango::DeviceClass *cl,const char *s);
	/**
	 * Constructs a newly allocated Command object.
	 *
	 *	@param cl	Class.
	 *	@param s 	Device name
	 *	@param d	Device description.
	 */
	Undulator(Tango::DeviceClass *cl,const char *s,const char *d);
	/**
	 * The object destructor.
	 */	
	~Undulator() {delete_device();};



//	Miscellaneous methods
public:
	/**
	 *	will be called at device destruction or at init command.
	 */
	void delete_device();
	/**
	 *	Initialize the device
	 */
	virtual void init_device();
	/**
	 *	Read the device properties from database
	 */
	 void get_device_property();
	/**
	 *	Always executed method before execution command method.
	 */
	virtual void always_executed_hook();


//	Attribute methods
public:
	/**
	 *	Method      : Undulator::read_attr_hardware()
	 *	Description : Hardware acquisition for attributes.
	 */
	virtual void read_attr_hardware(vector<long> &attr_list);


	/**
	 *	Gap attribute related methods.
	 *	Description: Read-back and set-point for current gap. 
 *	             Writing to this attribute commences movement for the gap, 
 *	             using the current operator center offset and taper.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_Gap(Tango::Attribute &attr);
	virtual void write_Gap(Tango::WAttribute &attr);
	virtual bool is_Gap_allowed(Tango::AttReqType type);



	/**
	 *	EngineeringLock attribute related methods.
	 *	Description: Setting this attribute to TRUE disables operator composite movements. 
 *	             Engineering movements to be done directly on the ControlBox axis devices.
	 *
	 *	Data type:	Tango::DevBoolean
	 *	Attr type:	Scalar 
	 */
	virtual void read_EngineeringLock(Tango::Attribute &attr);
	virtual void write_EngineeringLock(Tango::WAttribute &attr);
	virtual bool is_EngineeringLock_allowed(Tango::AttReqType type);



	/**
	 *	GapAcceleration attribute related methods.
	 *	Description: Gap movement average acceleration in um/s^2.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_GapAcceleration(Tango::Attribute &attr);
	virtual void write_GapAcceleration(Tango::WAttribute &attr);
	virtual bool is_GapAcceleration_allowed(Tango::AttReqType type);



	/**
	 *	GapSpeed attribute related methods.
	 *	Description: Final profile velocity in um/s for gap movements.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_GapSpeed(Tango::Attribute &attr);
	virtual void write_GapSpeed(Tango::WAttribute &attr);
	virtual bool is_GapSpeed_allowed(Tango::AttReqType type);



	/**
	 *	PhaseAcceleration attribute related methods.
	 *	Description: Phase movement average acceleration in um/s^2.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_PhaseAcceleration(Tango::Attribute &attr);
	virtual void write_PhaseAcceleration(Tango::WAttribute &attr);
	virtual bool is_PhaseAcceleration_allowed(Tango::AttReqType type);



	/**
	 *	PhaseMode attribute related methods.
	 *	Description: Read-back and set-point for desired phase mode. 
 *	             Will be used next time Phase is written.
	 *
	 *	Data type:	Tango::DevShort
	 *	Attr type:	Scalar 
	 */
	virtual void read_PhaseMode(Tango::Attribute &attr);
	virtual void write_PhaseMode(Tango::WAttribute &attr);
	virtual bool is_PhaseMode_allowed(Tango::AttReqType type);



	/**
	 *	Phase attribute related methods.
	 *	Description: Read-back and set-point for phase offset.
 *	             When this attribute is written new phase movement commences 
 *	             using phase mode specified in PhaseMode attribute.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_Phase(Tango::Attribute &attr);
	virtual void write_Phase(Tango::WAttribute &attr);
	virtual bool is_Phase_allowed(Tango::AttReqType type);



	/**
	 *	PhaseSpeed attribute related methods.
	 *	Description: Final profile velocity in um/s for phase (sub-girders) movement.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_PhaseSpeed(Tango::Attribute &attr);
	virtual void write_PhaseSpeed(Tango::WAttribute &attr);
	virtual bool is_PhaseSpeed_allowed(Tango::AttReqType type);



	/**
	 *	TaperAcceleration attribute related methods.
	 *	Description: Taper movement average acceleration in um/s^2.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_TaperAcceleration(Tango::Attribute &attr);
	virtual void write_TaperAcceleration(Tango::WAttribute &attr);
	virtual bool is_TaperAcceleration_allowed(Tango::AttReqType type);



	/**
	 *	Taper attribute related methods.
	 *	Description: Read-back and set-point value for the current taper. 
 *	             Will be applied next time the GapSetpoint attribute is modified.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_Taper(Tango::Attribute &attr);
	virtual void write_Taper(Tango::WAttribute &attr);
	virtual bool is_Taper_allowed(Tango::AttReqType type);



	/**
	 *	Offset attribute related methods.
	 *	Description: Read-back and set-point value for the current vertical offset. 
 *	             Will be applied next time the Gap attribute is modified.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_Offset(Tango::Attribute &attr);
	virtual void write_Offset(Tango::WAttribute &attr);
	virtual bool is_Offset_allowed(Tango::AttReqType type);



	/**
	 *	TaperSpeed attribute related methods.
	 *	Description: Final profile velocity in um/s for taper movements.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_TaperSpeed(Tango::Attribute &attr);
	virtual void write_TaperSpeed(Tango::WAttribute &attr);
	virtual bool is_TaperSpeed_allowed(Tango::AttReqType type);



	/**
	 *	StopAll attribute related methods.
	 *	Description: Indicates that the undulator is in StopAll state inhibiting all motion.
	 *
	 *	Data type:	Tango::DevBoolean
	 *	Attr type:	Scalar 
	 */
	virtual void read_StopAll(Tango::Attribute &attr);
	virtual bool is_StopAll_allowed(Tango::AttReqType type);



	/**
	 *	GapMoving attribute related methods.
	 *	Description: Indicates that gap movement is in progress. 
 *	             Used to distinguish whether gap, phase or both are moving.
	 *
	 *	Data type:	Tango::DevBoolean
	 *	Attr type:	Scalar 
	 */
	virtual void read_GapMoving(Tango::Attribute &attr);
	virtual bool is_GapMoving_allowed(Tango::AttReqType type);



	/**
	 *	PhaseMoving attribute related methods.
	 *	Description: Indicates that phase movement is in progress. 
 *	             Used to distinguish whether gap, phase or both are moving.
	 *
	 *	Data type:	Tango::DevBoolean
	 *	Attr type:	Scalar 
	 */
	virtual void read_PhaseMoving(Tango::Attribute &attr);
	virtual bool is_PhaseMoving_allowed(Tango::AttReqType type);



	/**
	 *	EngineeringGapSpeed attribute related methods.
	 *	Description: Final profile velocity in um/s for gap axes engineering movement.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_EngineeringGapSpeed(Tango::Attribute &attr);
	virtual void write_EngineeringGapSpeed(Tango::WAttribute &attr);
	virtual bool is_EngineeringGapSpeed_allowed(Tango::AttReqType type);



	/**
	 *	EngineeringPhaseSpeed attribute related methods.
	 *	Description: Final profile velocity in um/s for phase axes engineering movement.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_EngineeringPhaseSpeed(Tango::Attribute &attr);
	virtual void write_EngineeringPhaseSpeed(Tango::WAttribute &attr);
	virtual bool is_EngineeringPhaseSpeed_allowed(Tango::AttReqType type);



	/**
	 *	EngineeringGapAcceleration attribute related methods.
	 *	Description: Gap axes engineering movement average acceleration/deceleration in um/s^2.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_EngineeringGapAcceleration(Tango::Attribute &attr);
	virtual void write_EngineeringGapAcceleration(Tango::WAttribute &attr);
	virtual bool is_EngineeringGapAcceleration_allowed(Tango::AttReqType type);



	/**
	 *	EngineeringPhaseAcceleration attribute related methods.
	 *	Description: Phase axes engineering movement average acceleration/deceleration in um/s^2.
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_EngineeringPhaseAcceleration(Tango::Attribute &attr);
	virtual void write_EngineeringPhaseAcceleration(Tango::WAttribute &attr);
	virtual bool is_EngineeringPhaseAcceleration_allowed(Tango::AttReqType type);



	/**
	 *	Interlock attribute related methods.
	 *	Description: Indicates that interlock is in effect.
	 *
	 *	Data type:	Tango::DevBoolean
	 *	Attr type:	Scalar 
	 */
	virtual void read_Interlock(Tango::Attribute &attr);
	virtual bool is_Interlock_allowed(Tango::AttReqType type);



	/**
	 *	CorrectionEnabled attribute related methods.
	 *	Description: Enables correction.
	 *
	 *	Data type:	Tango::DevBoolean
	 *	Attr type:	Scalar 
	 */
	virtual void read_CorrectionEnabled(Tango::Attribute &attr);
	virtual void write_CorrectionEnabled(Tango::WAttribute &attr);
	virtual bool is_CorrectionEnabled_allowed(Tango::AttReqType type);



	/**
	 *	AxesFlags attribute related methods.
	 *	Description: Represents bit-encoded axis flags
 *	             
 *	             Least significant byte, bits 0..7 represent communication error status for motors 1 to 8 respectively
 *	             More significant byte, bits 8..15 represent encoder error status for motors 1 to 8 respectively
 *	             More significant byte, bits 15..23 represent drive error status for motors 1 to 8 respectively
	 *
	 *	Data type:	Tango::DevULong
	 *	Attr type:	Scalar 
	 */
	virtual void read_AxesFlags(Tango::Attribute &attr);
	virtual bool is_AxesFlags_allowed(Tango::AttReqType type);



	/**
	 *	CycleTime attribute related methods.
	 *	Description: Time between poller cycles, in milliseconds
	 *
	 *	Data type:	Tango::DevDouble
	 *	Attr type:	Scalar 
	 */
	virtual void read_CycleTime(Tango::Attribute &attr);
	virtual bool is_CycleTime_allowed(Tango::AttReqType type);



	/**
	 *	Method      : Undulator::add_dynamic_attributes()
	 *	Description : Add dynamic attributes if any.
	 */
		void add_dynamic_attributes();

//	Command related methods
public: 


	/**
	 *	Command StopGap related methods.
	 */
	void stop_gap();
	virtual bool is_StopGap_allowed(const CORBA::Any &any);

	/**
	 *	Command ToggleStopAll related methods.
	 */
	void toggle_stop_all(Tango::DevBoolean argin);
	virtual bool is_ToggleStopAll_allowed(const CORBA::Any &any);

	/**
	 *	Command StopPhase related methods.
	 */
	void stop_phase();
	virtual bool is_StopPhase_allowed(const CORBA::Any &any);

	/**
	 *	Command CalibrateGap related methods.
	 */
	void calibrate_gap(const Tango::DevVarDoubleArray *argin);
	virtual bool is_CalibrateGap_allowed(const CORBA::Any &any);

	/**
	 *	Command CalibratePhase related methods.
	 */
	void calibrate_phase();
	virtual bool is_CalibratePhase_allowed(const CORBA::Any &any);

	/**
	 *	Command LoadCorrectionData related methods.
	 */
	void load_correction_data(Tango::DevString argin);
	virtual bool is_LoadCorrectionData_allowed(const CORBA::Any &any);

	/**
	 *	Command ResetDrive related methods.
	 */
	void reset_drive(Tango::DevUShort argin);
	virtual bool is_ResetDrive_allowed(const CORBA::Any &any);



	/*----- PROTECTED REGION ID(Undulator::Additional Method prototypes) ENABLED START -----*/
public:

	/**
	 *  Mutator method that updates the reported ID positions. Thread-safe.
	 *
	 *  @param newPos
	 */
	void update_position(const IDPosition &newPos);

	/**
	 * Mutator method that updates the reported ID status flags. Thread-safe.
	 */
	void update_status(const IDStatus &newStatus);


	/**
	 * Updates the poller cycle time attribute - CycleTime
	 *
	 * @param newTime new value for the attribute
	 */
	void update_cycle_time(double newTime);

	/**
	 * Getter method to read StopAll status
	 *
	 * @returns StopAll status
	 */
	bool get_stop_all() const { return idStatus.stopAll; }

	/**
	 * Getter method to read Interlock status
	 *
	 * @returns Interlock status
	 */
	bool get_interlock() const { return idStatus.interlock; }


	/**
	 * Getter method to read the axes flags
	 *
	 * @returns the axis flags
	 */
	unsigned int get_axis_flags() const { return idStatus.axesFlags; }

	/**
	 * Getter method to read Gap moving status
	 *
	 * @returns whether gap is moving
	 */
	 bool get_gap_moving() const { return idStatus.gapMoving; }

	/**
	 * Getter method to read Gap moving status
	 *
	 * @returns whether phase is moving
	 */
	 bool get_phase_moving() const { return idStatus.phaseMoving; }


private:

	/**
	 * Calculates final destinations of phase axes depending on desired phase.
	 *
	 * @param destinations Destinations vector to fill.
	 */
	void calculate_phase_motor_destinations(vector<double> &destinations);


	/**
	 *  Gets offsets from all gap axes and stores them in offsetsGap array.
	 */
	void get_offsets_gap();

	/**
     *  Gets offsets from all phase axes and stores them in offsetsPhase array.
     */
    void get_offsets_phase();


	/**
	 * Takes user unit and converts it to counts.
	 *
	 * @param number User unit value to convert to counts.
	 * @param ratio Ratio to use for conversion.
	 * @return Converted user units in counts.
	 */
    double convert_to_counts(double number, double ratio) {
    	 return number / ratio;
    }

    /**
     * Converts counts to micrometers using given ratio.
     *
     * @param value Value to convert to micrometers.
     * @param ratio Ratio to use for conversion.
     * @return Converted value.
     */
    double convert_to_micrometers(double value, double ratio) {
    	return value * ratio;
    }

    /**
     * Creates command to start desired gap movement.
     * Executes the command on DMC.
     */
    void start_gap();

    /**
     * Calculates final motor positions, sends required parameters
     * and starts phase movement on DMC.
     */
    void start_phase();

	/*----- PROTECTED REGION END -----*/	//	Undulator::Additional Method prototypes

};

	/*----- PROTECTED REGION ID(Undulator::Additional Classes Definitions) ENABLED START -----*/

	//	Additional Classes definitions

	/*----- PROTECTED REGION END -----*/	//	Undulator::Additional Classes Definitions

} //	namespace

#endif	//	UNDULATOR_H
